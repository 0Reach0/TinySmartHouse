#include "stm8s.h"

// ??????? ??? NRF24L01+
#define NRF24L01_CMD_W_REGISTER 0x20
#define NRF24L01_CMD_R_REGISTER 0x00
#define NRF24L01_CMD_R_RX_PAYLOAD 0x61
#define NRF24L01_CMD_W_TX_PAYLOAD 0xA0

// ????????
void delay(uint16_t n) {
	uint16_t i =0;
    for(i = 0; i < n; i++) {
        __asm("nop");  // ??????? ???????????? ??????? NOP
    }
}


// ?????????? CSN
static void cs_high(void) {
    GPIO_WriteHigh(GPIOC, GPIO_PIN_4); // CSN ?? PC4
}

static void cs_low(void) {
    GPIO_WriteLow(GPIOC, GPIO_PIN_4); // CSN ?? PC4
}

// ?????????? CE
static void ce_high(void) {
    GPIO_WriteHigh(GPIOC, GPIO_PIN_3); // CE ?? PC3
}

static void ce_low(void) {
    GPIO_WriteLow(GPIOC, GPIO_PIN_3); // CE ?? PC3
}

// ?????? ???????? NRF24L01+
uint8_t nrf24l01p_read_register(uint8_t reg) {
    uint8_t command = NRF24L01_CMD_R_REGISTER | reg;
    uint8_t data = 0;

    cs_low();
    SPI_SendData(command);
					delay(10);
    while (SPI_GetFlagStatus(SPI_FLAG_TXE) == RESET); // ???????? ???????? ???????
    while (SPI_GetFlagStatus(SPI_FLAG_RXNE) == RESET); // ???????? ????????? ??????
    data = SPI_ReceiveData();
		delay(10);
		 SPI_SendData(0x0);
		 		 delay(10);
		 while (SPI_GetFlagStatus(SPI_FLAG_TXE) == RESET); 
		 while (SPI_GetFlagStatus(SPI_FLAG_RXNE) == RESET); // ???????? ????????? ??????
		data = SPI_ReceiveData();

cs_high();

    return data;
}

// ?????? ? ??????? NRF24L01+
void nrf24l01p_write_register(uint8_t reg, uint8_t value) {
    uint8_t command = NRF24L01_CMD_W_REGISTER | reg;

    cs_low();
    SPI_SendData(command);
    while (SPI_GetFlagStatus(SPI_FLAG_TXE) == RESET);
    SPI_SendData(value);
    while (SPI_GetFlagStatus(SPI_FLAG_TXE) == RESET);
		delay(10);
    cs_high();
}

void nrf24l01p_read_registerN(uint8_t reg, uint8_t *buf, uint8_t len) {
    uint8_t command = NRF24L01_CMD_R_REGISTER | reg;
    uint8_t i;

    cs_low(); // ???????? CSN

    // ????????? ??????? ?????? ????????
    SPI_SendData(command);
    while (SPI_GetFlagStatus(SPI_FLAG_TXE) == RESET); // ???????? ?????????? ????????
		delay(20);
    while (SPI_GetFlagStatus(SPI_FLAG_RXNE) == RESET); // ???????? ????????? ??????
		SPI_ReceiveData(); // ??????? ?????????? "????????" ?????? (???? ????)
    // ?????? ?????? ?? ????????
    for (i = 0; i < len; i++) {
			delay(10);
        SPI_SendData(0xFF); // ????????? ???????? (0xFF) ??? ??????
        while (SPI_GetFlagStatus(SPI_FLAG_TXE) == RESET); // ???????? ?????????? ????????
				delay(10);
        while (SPI_GetFlagStatus(SPI_FLAG_RXNE) == RESET); // ???????? ????????? ??????
        buf[i] = SPI_ReceiveData(); // ????????? ???????? ?????? ? ?????
    }

    cs_high(); // ??????? CSN
}


// ?????? ? ??????? NRF24L01+ ? ??????????? ???????
void nrf24l01p_write_registerN(uint8_t reg, const uint8_t *buf, uint8_t len) {
    uint8_t command = NRF24L01_CMD_W_REGISTER | reg;
    uint8_t i;

    cs_low();
    SPI_SendData(command);
    while (SPI_GetFlagStatus(SPI_FLAG_TXE) == RESET);
		delay(10);
    for (i = 0; i < len; i++) {
			delay(10);
        SPI_SendData(buf[i]);
        while (SPI_GetFlagStatus(SPI_FLAG_TXE) == RESET);
    }
	delay(10);
    cs_high();
}
		void nrf24l01p_flush_tx(void) {
    cs_low();                  // ?????????? CSN (?????? SPI ????????)
    SPI_SendData(0xE1); // ?????????? ??????? FLUSH_TX
		delay(10);
    cs_high();                 // ???????????? CSN (????? SPI ????????)
}
// ???????? ?????? ? NRF24L01+
void nrf24l01p_tx_send(const uint8_t *data, uint8_t len) {
    uint8_t i;
    uint8_t status;

    // ??????? TX FIFO ????? ?????????
    nrf24l01p_flush_tx();

    // ???????? CSN ??? ?????? ???????? ??????
    cs_low();
    SPI_SendData(NRF24L01_CMD_W_TX_PAYLOAD);
    while (SPI_GetFlagStatus(SPI_FLAG_TXE) == RESET);

    // ?????????? ??????
    for (i = 0; i < len; i++) {
			delay(10);
        SPI_SendData(data[i]);
        while (SPI_GetFlagStatus(SPI_FLAG_TXE) == RESET);
    }
		delay(10);
    cs_high();
	delay(10);
    // ????????????? CE ?????? ??? ?????? ????????
    ce_high();
    delay(10);  // ???????? ???????? ??? ????????
    ce_low();

    // ????????? ????????? ??????? ??? ????????????? ?????????? ????????
    do {
        status = nrf24l01p_read_register(0x07);  // ?????? ????????? ???????
    } while (!(status & (1 << 5)) && !(status & (1 << 4)));  // ????, ???? TX_DS (??? 5) ??? MAX_RT (??? 4) ?? ???????????

    // ?????????? ????? ? ????????? ????????
    nrf24l01p_write_register(0x07, 0x70); // Clear status flags
}

// ????????????? SPI ??? NRF24L01+
void SPI_Init_NRF(void) {
    GPIO_Init(GPIOC, GPIO_PIN_5, GPIO_MODE_OUT_PP_HIGH_FAST); // SCK
    GPIO_Init(GPIOC, GPIO_PIN_6, GPIO_MODE_OUT_PP_HIGH_FAST); // MOSI
    GPIO_Init(GPIOC, GPIO_PIN_7, GPIO_MODE_IN_PU_NO_IT);      // MISO
		
    SPI_Init(SPI_FIRSTBIT_MSB, SPI_BAUDRATEPRESCALER_8, SPI_MODE_MASTER,
             SPI_CLOCKPOLARITY_LOW, SPI_CLOCKPHASE_1EDGE, SPI_DATADIRECTION_2LINES_FULLDUPLEX,
             SPI_NSS_SOFT, 0x07);
    SPI_Cmd(ENABLE);
}

// ????? ????????? NRF24L01+
void nrf24l01p_reset_status(void) {
    nrf24l01p_write_register(0x07, 0x70);
}

// ????????????? ????????? NRF24L01+
void nrf24l01p_rx_init(void) {
    uint8_t rxaddr[] = {0x01, 0x01, 0x01, 0x01, 0x01};

    cs_low();
    nrf24l01p_write_register(0x00, 0x0F); // Power up, PRX mode
    delay(10);
    nrf24l01p_write_register(0x01, 0x01); // Enable auto-ack for pipe 0
    delay(10);
    nrf24l01p_write_register(0x02, 0x01); // Enable pipe 0
    delay(10);
    nrf24l01p_write_register(0x03, 0x03); // Address width: 5 bytes
    delay(10);
    nrf24l01p_write_register(0x05, 120); // RF channel 120
    delay(10);
    nrf24l01p_write_register(0x06, 0x08); // Data rate: 2Mbps, output power: 0dBm
    delay(10);
    nrf24l01p_write_register(0x07, 0x70); // Clear status flags
    delay(10);
    nrf24l01p_write_registerN(0x0A, rxaddr, 5); // Set RX address for pipe 0
    delay(10);
    nrf24l01p_write_register(0x11, 0x01); // Number of bytes in RX payload in pipe 0
    delay(10);
    cs_high();
    ce_high(); // Start listening
}

// ????????????? ??????????? NRF24L01+
void nrf24l01p_tx_init(void) {
    uint8_t txaddr[] = {0x01, 0x01, 0x01, 0x01, 0x01};

    cs_high();
    ce_low();
    nrf24l01p_write_register(0x00, 0x0E); // Power up, PTX mode
    delay(10);
    nrf24l01p_write_register(0x03, 0x03); // Address width: 5 bytes
    delay(10);
    nrf24l01p_write_register(0x04, 0xFF); // Retry delay 4000us, retry count 15
    delay(10);
    nrf24l01p_write_register(0x05, 120); // RF channel 120
    delay(10);
    nrf24l01p_write_register(0x06, 0x0C); // Data rate: 2Mbps, output power: 0dBm
    delay(10);
    nrf24l01p_write_register(0x07, 0x70); // Clear status flags
    delay(10);
    nrf24l01p_write_registerN(0x10, txaddr, 5); // Set TX address
    delay(10);
    ce_high();
}
// ??????? ??? ?????? ??????, ???????? NRF24L01+
uint8_t nrf24l01p_rx_read(uint8_t *buf, uint8_t len) {
    uint8_t i;
    uint8_t status;

    cs_low();
    SPI_SendData(NRF24L01_CMD_R_RX_PAYLOAD);  // ??????? ??? ?????? ?????? ?? ?????? ??????
		    while (SPI_GetFlagStatus(SPI_FLAG_RXNE) == RESET); // ???????? ????????? ??????
    SPI_ReceiveData(); // ??????? ?????????? "????????" ?????? (???? ????)
    while (SPI_GetFlagStatus(SPI_FLAG_TXE) == RESET);  // ??????? ?????????? ???????? ??????
    for (i = 0; i < len; i++) {
        SPI_SendData(0x00);  // ?????????? 0 ??? ?????? ??????
        while (SPI_GetFlagStatus(SPI_FLAG_RXNE) == RESET);  // ??????? ????????? ??????
        buf[i] = SPI_ReceiveData();  // ?????? ??????
    }
    cs_high();

    // ?????? ? ?????????? ???? ??????????
    status = nrf24l01p_read_register(0x07);  // ?????? ???????? ???????
    nrf24l01p_write_register(0x07, status | 0x70);  // ????? ????? ??????????

    return status;  // ?????????? ??????
}

int check_tx(void)
{
uint8_t reg;
uint8_t regn[5];
 reg =  nrf24l01p_read_register(0x07);
 if(reg != 0x0e)
	{return -1;} 
nrf24l01p_read_registerN(0x10, regn, 5);
if(regn[0] != 0x1)return -1;
if(regn[1] != 0x1)return -1;
if(regn[2] != 0x1)return -1;
if(regn[3] != 0x1)return -1;
if(regn[4] != 0x1)return -1;
return 0;
}
int check_rx(void){
uint8_t reg;
uint8_t regn[5];
 reg =  nrf24l01p_read_register(0x01);
 delay(10);
 if(reg != 0x1)
{return -1;} 
 reg =  nrf24l01p_read_register(0x02);
 delay(10);
 if(reg != 0x1)
{return -1;} 
 reg =  nrf24l01p_read_register(0x07);
 delay(10);
 if(reg != 0x0e)
{return -1;} 
nrf24l01p_read_registerN(0x0A, regn, 5);
delay(10);
if(regn[0] != 0x1)return -1;
if(regn[1] != 0x1)return -1;
if(regn[2] != 0x1)return -1;
if(regn[3] != 0x1)return -1;
if(regn[4] != 0x1)return -1;
return 0;

}
// ??????? ???????
void main(void) {
    uint8_t tx_data[] = {0xAA,0xAA,0xAA};
    uint8_t rx_data[3];
		volatile uint8_t reg;
		uint8_t regn[5];
    cs_high();
    delay(100);
    GPIO_Init(GPIOC, GPIO_PIN_4, GPIO_MODE_OUT_PP_HIGH_FAST); // CSN
    GPIO_Init(GPIOC, GPIO_PIN_3, GPIO_MODE_OUT_PP_HIGH_FAST); // CE
    SPI_Init_NRF();
		GPIO_Init(GPIOB, GPIO_PIN_5, GPIO_MODE_OUT_PP_HIGH_FAST); // CSN
    // ????????????? ???????????
    nrf24l01p_rx_init();
    delay(1000);
		    GPIO_Init(GPIOB, GPIO_PIN_4, GPIO_MODE_IN_PU_IT);
    EXTI_SetExtIntSensitivity(EXTI_PORT_GPIOB, EXTI_SENSITIVITY_FALL_ONLY);
		//enableInterrupts();

    // ????????????? ?????????? ?? ??????
		reg = check_rx();
    if(reg!= 0)
	{
		
	GPIO_WriteLow(GPIOB, GPIO_PIN_5);
	while(1);
	}
    // ???????? ????
		ce_high();
    while (1) {
			reg = nrf24l01p_read_register(0x07);
      //  nrf24l01p_tx_send(tx_data, 1); // ???????? ??????
        delay(100); // ???????? 1 ???????
			if(reg & (1 << 6)) {
					nrf24l01p_rx_read(rx_data, 1);				// ???????? 6-?? ????
					while(1)
				{
						GPIO_WriteLow(GPIOB, GPIO_PIN_5);
						delay(50);
						GPIO_WriteHigh(GPIOB, GPIO_PIN_5);
						delay(50);
				}
			 nrf24l01p_write_register(0x07, reg | 0x70);}
		//				delay(10);
  //  nrf24l01p_write_register(0x07, 0x70);
   // delay(10);	
		}
		
}

#ifdef USE_FULL_ASSERT
void assert_failed(uint8_t* file, uint32_t line) {
    // ??????????? ???? ? ?????? ??????
    while (1);
}
#endif
